{% extends "base.html" %}

{% block content %}
<div class="tile pad" style="max-width:1200px;margin:20px auto;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px;">
    <h2 class="hdr" style="margin:0;">Review Lineups</h2>
    <a class="btn-ghost" href="{{ url_for('lineups.lineups_index') }}">Change Week</a>
  </div>

  <form method="POST" action="{{ url_for('lineups.lineups_submit') }}">
    <input type="hidden" name="week" value="{{ week }}"/>

    <div class="leagues-grid">
      {% for item in items %}
        {% set lg = item.league %}
        <div class="tile pad dark league-tile" data-req="{{ item.starters_label|e }}">
          <div class="league-head">
            <div class="lh-left">
              <h3 class="lh-title">
                {{ lg.name }}{% if item.my_team_name %} • {{ item.my_team_name }}{% endif %}
              </h3>
              <div class="lh-sub mini">
                MFL {{ lg.mfl_id }} • Season {{ lg.year }}
                {% if item.starters_label %} • <strong>Lineup:</strong> {{ item.starters_label }}{% endif %}
              </div>
            </div>
            <div class="lh-right">
              <label class="include-label">
                <input type="checkbox" name="include_{{ lg.id }}" value="1">
                <span>Include</span>
              </label>
            </div>
          </div>

          {% set grouped = item.grouped_players %}
          {% if not grouped or (grouped|length == 0) %}
            <div class="mini" style="opacity:.9;">No rostered players found for this league.</div>
          {% else %}
            <div class="pos-grid">
              {% for pos in ['QB','RB','WR','TE','Other'] %}
                {% if grouped.get(pos) %}
                  <div class="pos-card" data-pos="{{ pos }}">
                    <div class="pos-head">
                      <strong>{{ pos }}</strong>
                      <!-- This shows the requirement (e.g., 1-2) and turns red until satisfied -->
                      <span class="req-badge mini" data-pos="{{ pos }}">—</span>
                    </div>

                    <table class="dense-table">
                      <thead>
                        <tr>
                          <th style="width:36px;">&nbsp;</th>
                          <th>Player</th>
                          <th class="ta-r" style="width:64px;">Proj</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in grouped[pos] %}
                          <tr>
                            <td class="ta-c">
                              <input class="chk"
                                     type="checkbox"
                                     name="starters_{{ lg.id }}[]"
                                     value="{{ row.player_id }}"
                                     data-pos="{{ pos }}">
                            </td>
                            <td class="nowrap">
                              <span class="pname">{{ row.name or '—' }}</span>
                              {% if row.team %}
                                <span class="pmeta mini">&nbsp;•&nbsp;{{ row.position or pos }}&nbsp;{{ row.team }}</span>
                              {% else %}
                                <span class="pmeta mini">&nbsp;•&nbsp;{{ row.position or pos }}</span>
                              {% endif %}
                            </td>
                            <td class="ta-r">
                              {% if row.projected is not none %}
                                {{ '%.2f'|format(row.projected) }}
                              {% else %}—{% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div class="actions">
      <button type="submit" class="btn-ghost">Submit Lineups</button>
    </div>

    <div class="mini hint">
      Select <strong>Include</strong> for each league you want to submit. A league stays <span style="color:#ff6b6b;font-weight:600;">red</span> on a position
      until its requirement is met (e.g., <code>1-2</code>).
    </div>
  </form>
</div>

<style>
  .mini { font-size:12px; }
  .leagues-grid { display:grid; grid-template-columns: 1fr; gap:12px; }
  .league-tile { border-radius:12px; }
  .league-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
  .lh-title { margin:0 0 2px; font-size:16px; }
  .lh-sub { opacity:.85; }
  .include-label { display:flex; align-items:center; gap:8px; user-select:none; }
  .include-label input { transform: scale(1.05); }

  .pos-grid { display:grid; gap:10px; grid-template-columns: repeat(3, minmax(0, 1fr)); }
  @media (max-width: 1100px) { .pos-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 720px) { .pos-grid { grid-template-columns: 1fr; } }

  .pos-card { border:1px solid rgba(255,255,255,.12); border-radius:10px; overflow:hidden; }
  .pos-head {
    padding:6px 8px; background:rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:space-between;
  }
  .req-badge { padding:2px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.16); }
  .req-badge.need { color:#ff6b6b; border-color: rgba(255,107,107,.6); background: rgba(255,107,107,.08); font-weight:700; }

  /* Dense table */
  .dense-table { width:100%; border-collapse:collapse; font-size:13px; }
  .dense-table thead th { text-align:left; font-weight:600; opacity:.85; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.08); }
  .dense-table tbody td { padding:4px 8px; border-bottom:1px solid rgba(255,255,255,.06); line-height: 1.2; vertical-align: middle; }
  .dense-table tbody tr:last-child td { border-bottom:0; }
  .ta-r { text-align:right; }
  .ta-c { text-align:center; }
  .nowrap { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pname { font-weight:600; }
  .pmeta { opacity:.8; }
  .chk { transform: scale(.95); }

  .actions { display:flex; justify-content:flex-end; margin-top:10px; }
  .hint { opacity:.85; margin-top:6px; }
</style>

<script>
(function(){
  // Parse "11:QB:0-2,RB:2-4,WR:3-5,TE:1-3" into {QB:{min:0,max:2,label:"0-2"}, ...}
  function parseRequirements(s) {
    const map = {};
    if (!s) return map;
    s = String(s);

    // Strip total prefix "11:" if present
    const c = s.indexOf(':');
    if (c > 0 && /^\d+$/.test(s.slice(0, c))) {
      s = s.slice(c + 1);
    }

    s.split(',').forEach(tok => {
      const parts = tok.split(':');
      if (parts.length < 2) return;
      const pos = String(parts[0] || '').trim().toUpperCase();
      const val = String(parts[1] || '').trim();

      if (!pos || !val) return;
      let min, max;
      if (val.includes('-')) {
        const segs = val.split('-');
        min = parseInt(segs[0], 10);
        max = parseInt(segs[1], 10);
      } else {
        min = max = parseInt(val, 10);
      }
      if (Number.isFinite(min) && Number.isFinite(max)) {
        map[pos] = {min, max, label: val};
      }
    });
    return map;
  }

  function updateTile(tile) {
    const reqStr = tile.getAttribute('data-req') || '';
    const reqs = parseRequirements(reqStr);

    // For each pos header badge, set label and red/ok state based on checked boxes
    tile.querySelectorAll('.req-badge[data-pos]').forEach(badge => {
      const pos = badge.getAttribute('data-pos') || '';
      const req = reqs[pos.toUpperCase()];
      if (!req) {
        badge.textContent = '—';
        badge.classList.remove('need');
        return;
      }
      badge.textContent = req.label;

      const checked = tile.querySelectorAll(`input.chk[data-pos="${pos}"]:checked`).length;
      const ok = (checked >= req.min) && (checked <= req.max);
      badge.classList.toggle('need', !ok);
    });
  }

  // Wire up event listeners
  document.querySelectorAll('.league-tile').forEach(tile => {
    // Initial update
    updateTile(tile);
    // Recompute on any checkbox change inside the tile
    tile.addEventListener('change', (e) => {
      const tgt = e.target;
      if (tgt && tgt.classList && tgt.classList.contains('chk')) {
        updateTile(tile);
      }
    });
  });
})();
</script>
{% endblock %}
