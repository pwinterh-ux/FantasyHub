{% extends "base.html" %}

{% block content %}
<div class="tile pad" style="max-width:1100px;margin:24px auto;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;">
    <h2 class="hdr" style="margin:0;">My Leagues</h2>
    <a href="{{ url_for('mfl.mfl_config') }}" class="btn-ghost">Refresh Leagues</a>
  </div>

  <div class="tile pad dark" style="margin-top:8px;">
    <div class="responsive-table" style="overflow-x:auto;">
      <table style="width:100%; border-collapse:separate; border-spacing:0 8px; color:#eaf1f7;">
        <thead>
          <tr style="text-align:left; opacity:.9;">
            <th style="padding:10px;">League</th>
            <th style="padding:10px;">Season</th>
            <th style="padding:10px;">My Team</th>
            <th style="padding:10px;">Record</th>
            <th style="padding:10px;">Standing</th>
            <th style="padding:10px;">Starters</th>
          </tr>
        </thead>
        <tbody id="leagues-tbody">
          {% for league in leagues %}
            {% set my_team = my_teams.get(league.id) %}
            <tr class="league-row"
                data-league-row="{{ league.id }}"
                data-details-url="{{ url_for('leagues.league_details_json', league_id=league.id) }}"
                data-submit-url="{{ url_for('lineups.lineups_single_league', league_id=league.id, next=request.url) }}"
                style="
                  background: radial-gradient(120% 120% at 10% 0%, rgba(12,14,18,.86), rgba(8,10,12,.9));
                  color:#eaf1f7;
                  border:1px solid rgba(255,255,255,.12);
                  border-radius:12px;
                  box-shadow: 0 8px 22px rgba(0,0,0,.25);
                ">
              <td style="padding:14px; border-top-left-radius:12px; border-bottom-left-radius:12px; font-weight:600; cursor:pointer;">
                {{ league.name }}
                <div style="font-size: 12px; opacity:.8;">MFL: {{ league.mfl_id }}</div>
              </td>
              <td style="padding:14px; cursor:pointer;">{{ league.year }}</td>
              <td style="padding:14px; cursor:pointer;">{{ my_team.name if my_team else '—' }}</td>
              <td style="padding:14px; cursor:pointer;">{{ my_team.record if my_team and my_team.record else '—' }}</td>
              <td style="padding:14px; cursor:pointer;">{{ my_team.standing if my_team and my_team.standing is not none else '—' }}</td>
              <td style="padding:14px; border-top-right-radius:12px; border-bottom-right-radius:12px; cursor:pointer;">
                <!-- RAW DB VALUE -->
                <span class="roster-slots" data-raw="{{ league.roster_slots or '' }}">{{ league.roster_slots or 'Not set' }}</span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .details-row td {
    background: radial-gradient(120% 120% at 10% 0%, rgba(10,12,14,.92), rgba(6,8,10,.96));
    color: #eaf1f7;
    padding: 0 14px 16px 14px;
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 12px;
  }
  .details-panel { padding: 16px 6px 6px; }
  .details-top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin:0 0 10px; }
  .details-header { display:flex; align-items:center; flex-wrap:wrap; gap:10px; }
  .details-header h3 { margin:0; font-size:18px; color:#f4f7fa; }
  .mini { font-size:12px; opacity:.85; }

  .grid-2 { display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; }
  @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

  .standings-table, .roster-table, .picks-table {
    width:100%; border-collapse: collapse; background: transparent;
  }
  .standings-table th, .standings-table td,
  .roster-table th, .roster-table td,
  .picks-table th, .picks-table td {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    text-align:left;
    vertical-align: middle;
  }
  .standings-table th, .roster-table th, .picks-table th { font-weight:700; opacity:.95; }

  .is-mine { background: rgba(16,185,129,.12); }

  .spinner-inline {
    display:inline-block; width:16px; height:16px;
    border:2px solid rgba(255,255,255,0.25);
    border-top-color:#eaf1f7; border-radius:50%;
    animation: spin .7s linear infinite; vertical-align:-3px; margin-left:6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .league-row:hover { box-shadow: 0 12px 26px rgba(0,0,0,0.30); }

  .group-start td { padding-top: 12px; border-top: 1px dashed rgba(255,255,255,.15); }
  .pos-chip { font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:#0b1220; }

  .btn-compact { padding:6px 10px; font-size:12px; border-radius:10px; }
</style>

<script>
(function(){
  const tbody = document.getElementById('leagues-tbody');
  const baseOffersSearch = "{{ url_for('offers.search') }}";

  function pad4(x){ x = String(x || ''); return x.padStart(4, '0'); }

  function closeOpenDetails(exceptLeagueId) {
    document.querySelectorAll('tr.details-row').forEach(tr => {
      const lid = tr.getAttribute('data-for-league');
      if (!exceptLeagueId || String(lid) !== String(exceptLeagueId)) tr.remove();
    });
  }

  function standingsRows(teams, myFranchise) {
    return (teams || []).map((t, idx) => {
      const mine = myFranchise && String(t.mfl_id) === String(myFranchise);
      const rank = (t.standing !== null && t.standing !== undefined) ? t.standing : (idx + 1);
      return `
        <tr class="${mine ? 'is-mine' : ''}">
          <td style="width:56px;">${rank}</td>
          <td>${t.name || '—'}</td>
          <td>${t.record || '—'}</td>
          <td>${t.points_for ?? '—'}</td>
          <td>${t.points_against ?? '—'}</td>
        </tr>
      `;
    }).join('');
  }

  // RESTORED: roster with Sell action
  function renderRoster(roster) {
    const order = { QB: 0, RB: 1, WR: 2, TE: 3 };
    const items = (roster || []).slice().sort((a,b) => {
      const pa = (a.position || '').toUpperCase();
      const pb = (b.position || '').toUpperCase();
      const oa = (pa in order) ? order[pa] : 99;
      const ob = (pb in order) ? order[pb] : 99;
      if (oa !== ob) return oa - ob;
      const sa = a.is_starter ? 0 : 1;
      const sb = b.is_starter ? 0 : 1;
      if (sa !== sb) return sa - sb;
      return (a.name || '').localeCompare(b.name || '');
    });

    let lastPos = null;
    const rows = items.map(r => {
      const pos = (r.position || '').toUpperCase();
      const groupStart = lastPos !== null && pos !== lastPos ? 'group-start' : '';
      lastPos = pos;
      const team = r.team ? `<span class="mini" style="margin-left:6px;white-space:nowrap;">— ${r.team}</span>` : '';
      const sellHref = `${baseOffersSearch}?q=${encodeURIComponent(r.name || '')}&mode=sell`;
      return `
        <tr class="${groupStart}">
          <td style="width:64px;"><span class="pos-chip">${pos || '—'}</span></td>
          <td>${r.name || '—'} ${team}</td>
          <td style="width:100px;">
            <a class="btn-ghost btn-compact" href="${sellHref}">Sell</a>
          </td>
        </tr>
      `;
    }).join('');

    return `
      <div>
        <h4 style="margin: 8px 0 6px;">My Roster</h4>
        <table class="roster-table">
          <thead>
            <tr><th style="width:64px;">Pos</th><th>Player</th><th style="width:100px;">Action</th></tr>
          </thead>
          <tbody>
            ${rows || '<tr><td colspan="3" style="padding:10px;">No roster loaded.</td></tr>'}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderPicks(picks, teams) {
    const teamMap = {};
    (teams || []).forEach(t => { teamMap[pad4(t.mfl_id)] = t.name || pad4(t.mfl_id); });

    const rows = (picks || []).map(p => {
      const fid = pad4(p.original_team || '');
      const orig = teamMap[fid] || fid;
      return `
        <tr>
          <td style="width:70px;">${p.season}</td>
          <td style="width:70px;">R${p.round}</td>
          <td style="width:90px;">${p.pick_number ?? '—'}</td>
          <td>${orig}</td>
        </tr>
      `;
    }).join('');

    return `
      <div>
        <h4 style="margin: 8px 0 6px;">My Draft Picks</h4>
        <table class="picks-table">
          <thead>
            <tr><th style="width:70px;">Season</th><th style="width:70px;">Round</th><th style="width:90px;">Pick</th><th>Original Team</th></tr>
          </thead>
          <tbody>
            ${rows || '<tr><td colspan="4" style="padding:10px;">No draft picks loaded.</td></tr>'}
          </tbody>
        </table>
      </div>
    `;
  }

  async function toggleDetails(rowEl) {
    const leagueId = rowEl.getAttribute('data-league-row');
    const url = rowEl.getAttribute('data-details-url');
    const submitUrl = rowEl.getAttribute('data-submit-url');

    // close others
    const existing = document.querySelector(`tr.details-row[data-for-league="${leagueId}"]`);
    if (existing) { existing.remove(); return; }
    closeOpenDetails(leagueId);

    // placeholder row
    const loadingRow = document.createElement('tr');
    loadingRow.className = 'details-row';
    loadingRow.setAttribute('data-for-league', leagueId);

    const colCount = rowEl.children.length;
    const td = document.createElement('td');
    td.colSpan = colCount;
    td.innerHTML = `<div class="details-panel">Loading <span class="spinner-inline"></span></div>`;
    loadingRow.appendChild(td);
    rowEl.insertAdjacentElement('afterend', loadingRow);

    try {
      const res = await fetch(url, {
        credentials: 'same-origin',
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} ${res.statusText} ${txt ? '— ' + txt.slice(0,200) : ''}`);
      }
      const data = await res.json();

      const myFranchise = data.league && data.league.franchise_id ? String(data.league.franchise_id) : null;
      const synced = data.league && data.league.synced_at ? new Date(data.league.synced_at).toLocaleString() : '—';
      const teams = data.teams || [];
      const slots = (data.league && data.league.roster_slots) ? data.league.roster_slots : 'Not set';

      td.innerHTML = `
        <div class="details-panel">
          <div class="details-top">
            <div class="details-header">
              <h3>${data.league.name}</h3>
              <span class="mini">Season ${data.league.year} • MFL ${data.league.mfl_id} • Last sync: ${synced}</span>
            </div>
            <div>
              <a href="${submitUrl}" class="btn-ghost btn-compact" title="Submit lineup for this league">Submit Lineup</a>
            </div>
          </div>

          <div style="margin-bottom: 8px;">
            <strong>Lineup:</strong> ${slots}
          </div>

          <div class="grid-2">
            <div>
              <h4 style="margin:0 0 6px;">Standings</h4>
              <table class="standings-table">
                <thead>
                  <tr>
                    <th style="width:56px;">#</th>
                    <th>Team</th>
                    <th>Record</th>
                    <th>PF</th>
                    <th>PA</th>
                  </tr>
                </thead>
                <tbody>
                  ${standingsRows(teams, myFranchise) || '<tr><td colspan="5" style="padding:10px;">No team data found.</td></tr>'}
                </tbody>
              </table>
            </div>
            <div>
              ${renderRoster(data.my_roster)}
              ${renderPicks(data.my_draft_picks, teams)}
            </div>
          </div>
        </div>
      `;
    } catch (err) {
      console.error('League details fetch failed:', err);
      td.innerHTML = `<div class="details-panel">Could not load league details. Please try again.</div>`;
    }
  }

  // Row click -> expand/collapse
  tbody.addEventListener('click', (e) => {
    const row = e.target.closest('tr.league-row');
    if (!row) return;
    toggleDetails(row);
  });

  // NOTE: We show raw roster-slots from DB (no cleaning).
})();
</script>
{% endblock %}
