{% extends "base.html" %}

{% block content %}
<div class="page-wrap">
  <!-- Header / Summary -->
  <div class="tile pad" style="max-width:1200px;margin:12px auto 8px;">
    <div class="hdr-row">
      <div>
        <h2 class="hdr" style="margin:0;">Injury Assist â€” Week {{ week or 'â€”' }}</h2>
        <div class="sub">
          {% if payload.injury_report_timestamp %}
            Report generated at {{ payload.injury_report_timestamp }} UTC.
          {% elif payload.generated_at %}
            Data fetched at {{ payload.generated_at }} UTC.
          {% endif %}
          Data refreshes every {{ cache_ttl_minutes }} minutes.{% if used_cache %} Showing cached results.{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="tile pad dark" style="max-width:1200px;margin:0 auto 14px;">
    {% if payload.leagues and payload.leagues|length %}
      <div class="grid">
        {% for league in payload.leagues %}
          {% set starters = league.players | selectattr('is_starter') | list %}
          {% set bench = league.players | rejectattr('is_starter') | list %}

          <div class="card">
            <!-- Card header -->
            <div class="card-head">
              <div class="lh">
                <div class="name">{{ league.league_name }}</div>
                <div class="meta">Season {{ league.league_year }} â€¢ League ID {{ league.league_mfl_id }}</div>
              </div>
              <div class="rh">
                {% if league.submit_url %}
                  <a class="btn-mini" href="{{ league.submit_url }}">Submit lineup</a>
                {% endif %}
              </div>
            </div>

            <!-- Mellow summary chips -->
            <div class="chips soft">
              <span class="chip red">{{ league.red_count or 0 }} critical starter{{ 's' if (league.red_count or 0) != 1 }}</span>
              <span class="chip amb">{{ league.yellow_count or 0 }} questionable starter{{ 's' if (league.yellow_count or 0) != 1 }}</span>
              <span class="chip blu">{{ league.starter_count or 0 }} starter{{ 's' if (league.starter_count or 0) != 1 }} on report</span>
              <span class="chip mut">{{ league.player_count or 0 }} total on report</span>
            </div>

            <!-- Starters list (compact, high scan) -->
            <div class="list">
              <div class="list-hdr">Starters on report <span class="dim">({{ starters|length }})</span></div>

              {% if starters|length == 0 %}
                <div class="row muted">
                  <div class="main">
                    <div class="title">No starters on the injury report.</div>
                  </div>
                </div>
              {% else %}
                {% for p in starters %}
                  {% set up = (p.injury_status or '')|upper %}
                  {% set is_red = ('OUT' in up) or ('IR' in up) or ('PUP' in up) %}
                  {% set is_yellow = ('QUESTIONABLE' in up) %}
                  {% set cls = 'red' if is_red else ('yellow' if is_yellow else 'normal') %}
                  <div class="row {{ cls }}">
                    <div class="main">
                      <div class="title">
                        {{ p.name }}
                        <span class="pos">â€¢ {{ p.position }} Â· {{ p.team }}</span>
                      </div>
                      <div class="msg" title="{{ p.injury_details or '' }}">
                        {{ p.injury_details or 'â€”' }}
                      </div>
                    </div>
                    <div class="meta-col">
                      <div class="status">{{ p.injury_status or 'â€”' }}</div>
                      <div class="expected dim">{{ p.expected_return or 'â€”' }}</div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <!-- Non-starters (expand) -->
            {% if bench|length %}
              <details class="expander">
                <summary>Show all injured non-starters ({{ bench|length }} more)</summary>
                <div class="list compact">
                  {% for p in bench %}
                    <div class="row normal">
                      <div class="main">
                        <div class="title">
                          {{ p.name }}
                          <span class="pos">â€¢ {{ p.position }} Â· {{ p.team }}</span>
                        </div>
                        <div class="msg" title="{{ p.injury_details or '' }}">
                          {{ p.injury_details or 'â€”' }}
                        </div>
                      </div>
                      <div class="meta-col">
                        <div class="status">{{ p.injury_status or 'â€”' }}</div>
                        <div class="expected dim">{{ p.expected_return or 'â€”' }}</div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </details>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">
        <div class="emoji">ðŸ©º</div>
        <div>No leagues found.</div>
        <div class="dim">Sync your leagues to view injury information.</div>
      </div>
    {% endif %}
  </div>
</div>

<style>
  /* Base palette to match Rapid Lineups look */
  .page-wrap { --fg:#eaf1f7; --mut:#aeb7c3; --bd:rgba(255,255,255,.12); --bg2:#0b1220; }

  .hdr-row { display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
  .hdr { font-size:18px; }
  .sub { font-size:12px; color:var(--mut); }

  /* Grid to match lineups screen */
  .grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; }
  @media (max-width:1100px){ .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (max-width:720px){ .grid { grid-template-columns: 1fr; } }

  /* Card shell (same proportions as Rapid Lineups) */
  .card { border:1px solid var(--bd); border-radius:12px; background:rgba(10,12,14,.9); overflow:hidden; }

  .card-head{
    display:flex; align-items:flex-start; justify-content:space-between; gap:8px;
    padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08);
  }
  .name { font-weight:700; }
  .meta { font-size:12px; color:var(--mut); }
  .rh { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }

  /* Small primary button for CTA */
  .btn-mini{
    display:inline-flex; align-items:center; justify-content:center;
    padding:6px 10px; font-size:12px; border-radius:10px; text-decoration:none;
    background:var(--primary,#22c55e); color:#0b1220; font-weight:700;
    border:1px solid rgba(34,197,94,.25);
    box-shadow:0 2px 10px rgba(34,197,94,.18);
  }

  /* Chips (muted) */
  .chips{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.06); }
  .chips.soft .chip{ opacity:.9; }
  .chip{ border:1px solid var(--bd); padding:2px 8px; border-radius:999px; font-size:11px; background:rgba(255,255,255,.04); }
  .chip.red{    border-color:rgba(239,68,68,.35); }
  .chip.amb{    border-color:rgba(234,179,8,.35); }
  .chip.blu{    border-color:rgba(37,99,235,.30); }
  .chip.mut{    border-color:rgba(148,163,184,.35); }

  /* List rows (compact, high scan) */
  .list{ padding:8px 8px 10px; }
  .list.compact{ padding-top:6px; }
  .list-hdr{ font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:var(--mut); padding:0 2px 6px; }
  .dim{ opacity:.7; }

  .row{
    display:flex; gap:8px; align-items:flex-start; padding:8px; border-radius:10px;
    border:1px solid rgba(148,163,184,.18); background:rgba(148,163,184,.06);
  }
  .row + .row { margin-top:6px; }

  .row.normal{ background:rgba(148,163,184,.06); }
  .row.muted{ background:rgba(148,163,184,.04); }

  /* Stronger highlights (works on dark bg) */
  .row.red{
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.30);
    box-shadow: inset 3px 0 0 #ef4444;
  }
  .row.yellow{
    background: rgba(234,179,8,.10);
    border-color: rgba(234,179,8,.28);
    box-shadow: inset 3px 0 0 #f59e0b;
  }

  .main{ flex:1; min-width:0; }
  .title{ font-size:13px; font-weight:700; color:var(--fg); display:flex; gap:6px; align-items:center; }
  .title .pos{ font-weight:600; font-size:12px; color:var(--mut); }
  .msg{ font-size:12px; color:var(--fg); opacity:.95; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .meta-col{ display:flex; flex-direction:column; align-items:flex-end; gap:2px; min-width:120px; }
  .status{ font-size:12px; font-weight:800; text-transform:uppercase; }
  .expected{ font-size:12px; }

  /* Expander */
  .expander{ border-top:1px dashed rgba(148,163,184,.25); padding:8px 8px 10px; }
  .expander > summary{
    cursor:pointer; user-select:none; list-style:none; font-size:12px; color:var(--fg);
    opacity:.9; display:inline-flex; align-items:center; gap:8px; padding:2px 4px;
  }
  .expander > summary::-webkit-details-marker{ display:none; }

  /* Mobile behavior mirrors Lineups */
  @media (max-width:720px){
    .meta-col{ min-width:0; align-items:flex-start; }
    .status{ order:-1; }
  }

</style>
{% endblock %}
